name: Update Dependencies

on:
  workflow_dispatch:
    inputs:
      update-type:
        description: 'Update type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - all

permissions:
  contents: write
  pull-requests: write

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.0'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create update branch
        run: |
          BRANCH_NAME="deps/update-$(date +%Y%m%d-%H%M%S)"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          git checkout -b $BRANCH_NAME

      - name: Update Go dependencies
        id: update
        run: |
          echo "Starting dependency update..."
          
          # Backup original go.mod and go.sum
          cp go.mod go.mod.bak
          cp go.sum go.sum.bak
          
          # Update dependencies based on input
          case "${{ github.event.inputs.update-type }}" in
            "patch")
              echo "Updating patch versions only..."
              go get -u=patch ./...
              ;;
            "minor")
              echo "Updating patch and minor versions..."
              go get -u ./...
              ;;
            "all")
              echo "Updating all dependencies including major versions..."
              go get -u ./...
              # For major versions, you might want to update specific packages
              # go get -u github.com/Azure/azure-sdk-for-go/sdk/azcore@latest
              ;;
          esac
          
          go mod tidy
          
          # Check if there are changes
          if git diff --quiet go.mod go.sum; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No dependency updates available"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Dependencies updated successfully"
          fi

      - name: Run tests
        if: steps.update.outputs.has_changes == 'true'
        run: |
          echo "Running tests to ensure compatibility..."
          go test ./... -v -timeout 10m
        continue-on-error: true

      - name: Run linter
        if: steps.update.outputs.has_changes == 'true'
        uses: golangci/golangci-lint-action@v8
        with:
          args: --timeout 10m --disable staticcheck
        continue-on-error: true

      - name: Generate dependency diff
        if: steps.update.outputs.has_changes == 'true'
        id: diff
        run: |
          echo "## Dependency Changes" > changes.md
          echo "" >> changes.md
          echo "\`\`\`diff" >> changes.md
          git diff go.mod >> changes.md
          echo "\`\`\`" >> changes.md
          echo "" >> changes.md
          
          # Get list of updated packages
          echo "### Updated Packages" >> changes.md
          go list -m -u all | grep '\[' >> changes.md || echo "No updates in list" >> changes.md
          
          cat changes.md

      - name: Commit changes
        if: steps.update.outputs.has_changes == 'true'
        run: |
          git add go.mod go.sum
          git commit -m "chore: update Go dependencies (${{ github.event.inputs.update-type }})" \
                     -m "Update type: ${{ github.event.inputs.update-type }}" \
                     -m "Triggered by: @${{ github.actor }}"

      - name: Push changes
        if: steps.update.outputs.has_changes == 'true'
        run: |
          git push origin $BRANCH_NAME

      - name: Create Pull Request
        if: steps.update.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const changes = fs.readFileSync('changes.md', 'utf8');
            
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ”’ Security: Update Go dependencies (${{ github.event.inputs.update-type }})',
              head: process.env.BRANCH_NAME,
              base: 'main',
              body: `## ğŸ”„ Dependency Update
              
              This PR updates Go dependencies with **${{ github.event.inputs.update-type }}** update strategy.
              
              ### âš ï¸ Manual Review Required
              - [ ] Review dependency changes below
              - [ ] Verify test results
              - [ ] Check for breaking changes
              - [ ] Review security advisories
              
              ${changes}
              
              ### ğŸ“‹ Next Steps
              1. Review the changes carefully
              2. Run additional tests if needed
              3. Merge this PR to trigger ADO build pipeline
              4. Monitor the release process
              
              ---
              **Triggered by:** @${{ github.actor }}
              **Update type:** ${{ github.event.inputs.update-type }}
              **Workflow:** [View run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            });
            
            console.log(`Pull Request created: #${pr.number}`);
            
            // Add labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['dependencies', 'security', 'automated']
            });

      - name: No changes
        if: steps.update.outputs.has_changes == 'false'
        run: |
          echo "âœ… All dependencies are up to date!"
          echo "No pull request created."
