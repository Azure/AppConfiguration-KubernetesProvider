name: Trigger ADO Build

on:
  push:
    branches:
      - main
    paths:
      - 'go.mod'
      - 'go.sum'
      - '**.go'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  trigger-ado:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Azure DevOps Pipeline
        env:
          ADO_ORG: ${{ secrets.ADO_ORGANIZATION }}
          ADO_PROJECT: ${{ secrets.ADO_PROJECT }}
          ADO_PIPELINE_ID: ${{ secrets.ADO_PIPELINE_ID }}
          ADO_PAT: ${{ secrets.ADO_PAT }}
        run: |
          # Get commit information
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          BRANCH="${{ github.ref_name }}"
          
          echo "Triggering ADO Pipeline..."
          echo "Organization: $ADO_ORG"
          echo "Project: $ADO_PROJECT"
          echo "Pipeline ID: $ADO_PIPELINE_ID"
          echo "Branch: $BRANCH"
          echo "Commit: $COMMIT_SHA"
          
          # Trigger ADO Pipeline via REST API
          # Reference: https://learn.microsoft.com/en-us/rest/api/azure/devops/pipelines/runs/run-pipeline
          
          RESPONSE=$(curl -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Basic $(echo -n :$ADO_PAT | base64)" \
            -d "{
              \"resources\": {
                \"repositories\": {
                  \"self\": {
                    \"refName\": \"refs/heads/$BRANCH\",
                    \"version\": \"$COMMIT_SHA\"
                  }
                }
              },
              \"templateParameters\": {
                \"sourceCommit\": \"$COMMIT_SHA\",
                \"sourceBranch\": \"$BRANCH\",
                \"triggeredBy\": \"GitHub Actions\"
              }
            }" \
            "https://dev.azure.com/$ADO_ORG/$ADO_PROJECT/_apis/pipelines/$ADO_PIPELINE_ID/runs?api-version=7.1-preview.1")
          
          echo "ADO Response: $RESPONSE"
          
          # Check if trigger was successful
          if echo "$RESPONSE" | grep -q "\"id\""; then
            echo "âœ… ADO Pipeline triggered successfully!"
            RUN_ID=$(echo "$RESPONSE" | grep -o '"id":[0-9]*' | head -1 | cut -d':' -f2)
            echo "ADO Run ID: $RUN_ID"
            echo "View build: https://dev.azure.com/$ADO_ORG/$ADO_PROJECT/_build/results?buildId=$RUN_ID"
          else
            echo "âŒ Failed to trigger ADO Pipeline"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: Comment on PR (if applicable)
        if: github.event_name == 'push' && contains(github.event.head_commit.message, 'dependencies')
        uses: actions/github-script@v7
        with:
          script: |
            // Find the PR that was just merged
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              sort: 'updated',
              direction: 'desc',
              per_page: 5
            });
            
            const mergedPR = prs.find(pr => 
              pr.merge_commit_sha === context.sha && 
              pr.merged_at
            );
            
            if (mergedPR) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: mergedPR.number,
                body: `ðŸš€ **ADO Build Triggered**\n\nThe Azure DevOps build pipeline has been triggered for this dependency update.\n\n[View GitHub Action Run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
              });
            }
